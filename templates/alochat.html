<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Video + Chat + Audio</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
</head>
<body class="bg-gray-100 p-6 font-sans">

<!-- ÄÄƒng nháº­p -->
<div id="loginPanel" class="max-w-md mx-auto bg-white p-6 rounded-xl shadow-md">
  <h2 class="text-xl font-bold text-center mb-4 text-gray-700">ğŸ” Nháº­p tÃªn báº¥t ká»³ Ä‘á»ƒ vÃ o phÃ²ng</h2>
  <input id="usernameInput" class="w-full p-2 border rounded mb-4" placeholder="TÃªn ngÆ°á»i dÃ¹ng">
  <button onclick="login()" class="w-full py-2 bg-blue-500 text-white rounded hover:bg-blue-600">ÄÄƒng nháº­p</button>
</div>


<!-- Giao diá»‡n chÃ­nh -->
<div id="mainPanel" class="hidden max-w-3xl mx-auto mt-6 bg-white p-6 rounded-xl shadow-md space-y-4">
  <h2 class="text-lg font-bold text-center" id="userLabel">ğŸ‘¤ Báº¡n</h2>
 <div class="text-2xl font-bold text-green-600 text-center" id="statusLabel">ğŸŸ¢ ALO CHAT</div>


  <div class="flex gap-4 justify-center">
    <div>
      <h3 class="text-center text-gray-600 text-sm">ğŸ¥ Camera cá»§a báº¡n</h3>
      <video id="localVideo" autoplay muted class="w-60 h-32 border rounded object-cover"></video>
    </div>
    <div>
      <h3 class="text-center text-gray-600 text-sm">ğŸ¥ Camera ngÆ°á»i kia</h3>
      <video id="remoteVideo" autoplay class="w-60 h-32 border rounded object-cover"></video>
    </div>
  </div>
   <footer class="mt-10 py-4 text-center text-gray-700 text-sm font-medium rounded">
    Báº£n quyá»n Â© 2025 <span class="font-bold text-red-600">PHáº M HUY TUÃ‚N</span> Â· ÄT: <a href="tel:0389897989" class="text-blue-600 hover:underline">0389 897 989</a>
  </footer>
  <div class="flex justify-center gap-4">
    <button onclick="toggleCamera()" id="camBtn" class="py-2 px-4 bg-green-500 text-white rounded">ğŸ“· Báº­t Camera</button>
    <button onclick="toggleMic()" id="micBtn" class="py-2 px-4 bg-green-500 text-white rounded">ğŸ™ï¸ Báº­t Mic</button>
  </div>

  <div id="activityLabel" class="text-center text-sm text-red-500 hidden">ğŸ”´ Äang nÃ³i...</div>

  <input id="messageInput" class="border p-2 w-full rounded" placeholder="Nháº­p tin nháº¯n...">
  <button onclick="sendMessage()" class="px-4 py-1 bg-blue-500 text-white text-sm rounded hover:bg-blue-600">Gá»­i</button>


  <div id="chatBox" class="mt-4 p-2 bg-gray-50 h-32 overflow-y-auto text-sm border rounded"></div>
</div>

<script>
const socket = io();
let username = '';
let localStream;
let audioTrack, videoTrack;
let peerConnection;
const config = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

function login() {
  username = document.getElementById("usernameInput").value.trim();
  if (!username) return alert("Vui lÃ²ng nháº­p tÃªn!");

  document.getElementById("loginPanel").classList.add("hidden");
  document.getElementById("mainPanel").classList.remove("hidden");
  document.getElementById("userLabel").textContent = `ğŸ‘¤ ${username}`;

  socket.emit("user_online", { name: username });
}

socket.on("peer_online", data => {
  const other = data.name !== username ? data.name : null;
  if (other) {
    document.getElementById("statusLabel").textContent = `ğŸŸ¢ ${other} Ä‘ang online`;
    startConnection();
  }
});


function toggleCamera() {
  if (!videoTrack) {
    startMedia(true, false);
  } else {
    videoTrack.enabled = !videoTrack.enabled;
    document.getElementById("camBtn").textContent = videoTrack.enabled ? "ğŸ“· Táº¯t Camera" : "ğŸ“· Báº­t Camera";
  }
}

function toggleMic() {
  if (!audioTrack) {
    startMedia(false, true);
  } else {
    audioTrack.enabled = !audioTrack.enabled;
    document.getElementById("micBtn").textContent = audioTrack.enabled ? "ğŸ™ï¸ Táº¯t Mic" : "ğŸ™ï¸ Báº­t Mic";
  }
}

function startMedia(useVideo = true, useAudio = true) {
  navigator.mediaDevices.getUserMedia({ video: useVideo, audio: useAudio })
    .then(stream => {
      localStream = stream;
      document.getElementById("localVideo").srcObject = stream;

      if (useVideo) {
        videoTrack = stream.getVideoTracks()[0];
        document.getElementById("camBtn").textContent = "ğŸ“· Táº¯t Camera";
      }

      if (useAudio) {
        audioTrack = stream.getAudioTracks()[0];
        document.getElementById("micBtn").textContent = "ğŸ™ï¸ Táº¯t Mic";
        detectSpeaking(stream);
      }

      if (peerConnection) {
        stream.getTracks().forEach(track => peerConnection.addTrack(track, stream));
      }
    })
    .catch(e => alert("KhÃ´ng thá»ƒ truy cáº­p media: " + e));
}

function detectSpeaking(stream) {
  const ctx = new AudioContext();
  const source = ctx.createMediaStreamSource(stream);
  const analyser = ctx.createAnalyser();
  const data = new Uint8Array(analyser.frequencyBinCount);
  source.connect(analyser);

  function checkVolume() {
    analyser.getByteFrequencyData(data);
    const volume = data.reduce((a, b) => a + b, 0) / data.length;
    document.getElementById("activityLabel").classList.toggle("hidden", volume < 10);
    requestAnimationFrame(checkVolume);
  }

  checkVolume();
}

function startConnection() {
  peerConnection = new RTCPeerConnection(config);

  if (localStream) {
    localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
  }

  peerConnection.ontrack = event => {
    document.getElementById("remoteVideo").srcObject = event.streams[0];
  };

  peerConnection.onicecandidate = event => {
    if (event.candidate) {
      socket.emit("ice_candidate", { candidate: event.candidate });
    }
  };

  peerConnection.createOffer().then(offer => {
    return peerConnection.setLocalDescription(offer);
  }).then(() => {
    socket.emit("offer", { offer: peerConnection.localDescription });
  });
}

socket.on("offer", data => {
  if (!peerConnection) startConnection();

  peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer)).then(() => {
    return peerConnection.createAnswer();
  }).then(answer => {
    return peerConnection.setLocalDescription(answer);
  }).then(() => {
    socket.emit("answer", { answer: peerConnection.localDescription });
  });
});

socket.on("answer", data => {
  peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
});

socket.on("ice_candidate", data => {
  peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
});

function sendMessage() {
  const msg = document.getElementById("messageInput").value.trim();
  if (!msg) return;
  socket.emit("send_message", { from: username, text: msg });
  document.getElementById("messageInput").value = '';
}

socket.on("receive_message", data => {
  const chat = document.getElementById("chatBox");
  chat.innerHTML += `<p><strong>${data.from}:</strong> ${data.text}</p>`;
  chat.scrollTop = chat.scrollHeight;
});
</script>
<footer class="mt-10 py-4 text-center text-gray-700 text-sm font-medium rounded">
    Báº£n quyá»n Â© 2025 <span class="font-bold text-red-600">PHáº M HUY TUÃ‚N</span> Â· ÄT: <a href="tel:0389897989" class="text-blue-600 hover:underline">0389 897 989</a>
  </footer>
</body>
</html>
